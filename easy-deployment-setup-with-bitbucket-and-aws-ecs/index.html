<!doctype html><html lang=en-uk><head><meta charset=utf-8><meta name=generator content="Hugo 0.78.0"><meta name=viewport content="width=device-width,initial-scale=1"><link href="//fonts.googleapis.com/css?family=Open+Sans:400,800" rel=stylesheet type=text/css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/skeleton.css><link rel=stylesheet href=/css/custom.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><title>Easy Deployment Setup With Bitbucket and AWS ECS | Code Chauffeur</title><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-92329943-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Easy Deployment Setup With Bitbucket and AWS ECS"><meta property="og:description" content="Deployment is one of the most important parts of product development and launch. The better the deployment process is the faster it is. There are many deployment tools that make things easier today.
In this article, I will take you through a deployment setup with Bitbucket and AWS Elastic Container Service (ECS).
Requirements  Basic knowledge of git version control Basic knowledge of Docker An AWS account A Bitbucket account  Bitbucket is a web-based version control repository hosting service owned by Atlassian."><meta property="og:type" content="article"><meta property="og:url" content="https://codechauffeur.com/easy-deployment-setup-with-bitbucket-and-aws-ecs/"><meta property="og:image" content="https://codechauffeur.com/images/easy-deployment-with-bitbucket-and-ecs/easy-deployment-with-bitbucket-and-ecs.png"><meta property="article:published_time" content="2020-07-13T18:58:41+01:00"><meta property="article:modified_time" content="2020-07-13T18:58:41+01:00"><meta property="og:site_name" content="Code Chauffeur"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://codechauffeur.com/images/easy-deployment-with-bitbucket-and-ecs/easy-deployment-with-bitbucket-and-ecs.png"><meta name=twitter:title content="Easy Deployment Setup With Bitbucket and AWS ECS"><meta name=twitter:description content="Deployment is one of the most important parts of product development and launch. The better the deployment process is the faster it is. There are many deployment tools that make things easier today.
In this article, I will take you through a deployment setup with Bitbucket and AWS Elastic Container Service (ECS).
Requirements  Basic knowledge of git version control Basic knowledge of Docker An AWS account A Bitbucket account  Bitbucket is a web-based version control repository hosting service owned by Atlassian."><meta itemprop=name content="Easy Deployment Setup With Bitbucket and AWS ECS"><meta itemprop=description content="Deployment is one of the most important parts of product development and launch. The better the deployment process is the faster it is. There are many deployment tools that make things easier today.
In this article, I will take you through a deployment setup with Bitbucket and AWS Elastic Container Service (ECS).
Requirements  Basic knowledge of git version control Basic knowledge of Docker An AWS account A Bitbucket account  Bitbucket is a web-based version control repository hosting service owned by Atlassian."><meta itemprop=datePublished content="2020-07-13T18:58:41+01:00"><meta itemprop=dateModified content="2020-07-13T18:58:41+01:00"><meta itemprop=wordCount content="1163"><meta itemprop=image content="https://codechauffeur.com/images/easy-deployment-with-bitbucket-and-ecs/easy-deployment-with-bitbucket-and-ecs.png"><meta itemprop=keywords content="CI/CD,Deployment,DevOps,AWS,Bitbucket,Docker,"></head><body><div class=container><header role=contentinfo><div class=header-links><a href=/>Home</a> /
<a href=/articles/>Articles</a> /
<a href=/contact/>Contact</a> /
<a href=/portfolio/>Portfolio</a> /
<a href=/podcast/>Podcast</a> /</div></header><header role=banner><h1>Easy Deployment Setup With Bitbucket and AWS ECS</h1></header><div id=content><style>code{background:initial;border:none}</style><main role=main><div><article id=content><p>Deployment is one of the most important parts of product development and launch. The better the deployment process is the faster it is. There are many deployment tools that make things easier today.</p><p>In this article, I will take you through a deployment setup with Bitbucket and AWS Elastic Container Service (ECS).</p><h2 id=requirements>Requirements</h2><ul><li>Basic knowledge of <code>git</code> version control</li><li>Basic knowledge of <code>Docker</code></li><li>An AWS account</li><li>A Bitbucket account</li></ul><p><a href=https://bitbucket.org/>Bitbucket</a> is a web-based version control repository hosting service owned by Atlassian. They have built-in Continuous Integration and Delivery/Deployment (CI/CD).</p><p>We&rsquo;ll deploy a simple express app. Let&rsquo;s generate an express app</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>npx express-generator
</code></pre></div><p>If you don&rsquo;t have npx, you can install <code>express-generator</code> globally</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>npm install -g express-generator
express
</code></pre></div><p>Now we have our express app, let&rsquo;s create a docker file that we would use for deployment</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>touch Dockerfile
</code></pre></div><p>Copy this and paste in your <code>Dockerfile</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:8-alpine</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 3000</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [ <span style=color:#e6db74>&#34;npm&#34;</span>, <span style=color:#e6db74>&#34;start&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><h2 id=setup-aws-ecs>Setup AWS ECS</h2><p>Login to your AWS account and navigate to <a href=https://console.aws.amazon.com/ecs/home>ECS</a>.</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/ecs-home-page.png alt="AWS ECS Home page"></p><p>Navigate to <strong>Repositories</strong> under Amazon Elastic Container Registry (ECR).</p><p>AWS ECR is a container registry for docker. It&rsquo;s similar to Docker Hub. Container registries are used to store and distribute docker images.</p><p>Create a repository by clicking the &lsquo;Create repository&rsquo; button then give it a name like <code>my-express-app</code>.</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/create-repository-page.png alt="AWS ECR"></p><p>Now we have our repository URI: <code>XXXXXXXXXXX.region.amazonaws.com/my-express-app</code></p><h2 id=pushing-to-aws-ecr>Pushing to AWS ECR</h2><p>We will build our docker image and push it to our newly created repository on ECR.
For this article, we&rsquo;ll use <code>docker build</code>. If you have a more complex project setup, you may want to consider <a href=https://docs.docker.com/compose/>docker-compose</a></p><p>cd into the folder where the <code>Dockerfile</code> is and run</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>docker build -t my-express-app .
</code></pre></div><p>If the command ran well, you should have this:</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/docker-build-example.png alt="Run docker build"></p><p>To push the image to ECR, you have to first install <a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html>aws cli tool</a>.</p><p>Run <code>aws2 configure</code> to enter your AWS access ID and secret access key. Once you&rsquo;re done, run this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#66d9ef>$(</span>aws2 ecr get-login --no-include-email --region us-east-1<span style=color:#66d9ef>)</span>
</code></pre></div><p>Then push the docker image</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>docker tag my-express-app:latest XXXXXXXXXXX.region.amazonaws.com/my-express-app:latest
docker push XXXXXXXXXXX.region.amazonaws.com/my-express-app:latest
</code></pre></div><h2 id=setup-ecs-cluster>Setup ECS Cluster</h2><p>Navigate to the Clusters page. Click Create Cluster.</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/ecs-create-cluster.png alt="Creating a cluster"></p><p>We will use EC2 Linux + Networking.</p><p>You can use the following configuration to create the cluster:</p><ul><li>Give your cluster a name.</li><li>Create an empty cluster: Unchecked</li><li>Provisioning Model: On-Demand Instance</li><li>EC2 instance type: t2.nano (You can use whatever will fit your application needs)</li><li>Number of instances: 1</li><li>EC2 Ami Id: Amazon Linux 2 AMI [ami-08b26b905b0d17561]</li><li>Root EBS Volume Size (GiB): 30</li><li>Key pair: You can create anyone and attach it. This is the key you can use to ssh into the ec2 instance.</li><li>Networking: You can create a new VPC or use an existing one.<ul><li>Auto-assign public IP: Use subnet settings</li><li>Security group: Create a one that opens up port 80</li></ul></li><li>CloudWatch Container Insights: Unchecked</li></ul><h2 id=create-an-application-load-balancer>Create an Application Load Balancer</h2><p>An Application Load Balancer allows us to dynamically assign applications to routes using pattern matching. This will be used in the ECS Service</p><p>To create one, navigate to the load balancers tab on <a href=console.aws.amazon.com/ec2>EC2</a> and click on Create Load Balancer</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/creating-load-balancer.png alt="Create Load Balancer"></p><p>Give it a name, fill the Availability Zones, and add a security group that exposes port 80 and 443 (if you want to enable SSL).</p><p>In Step 4: Configure Routing, you&rsquo;d create a target group. You can skip Step 5.</p><h2 id=setup-ecs-task-definition--service>Setup ECS Task Definition & Service</h2><p>A task definition specifies the container information for our application. Navigate to Task Definitions and click on Create new Task Definition.</p><p>Select EC2 as launch type compatibility</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/create-ecs-task-def.png alt="Task definition"></p><p>You can use the following configuration to create the task definition:</p><ul><li>Task Definition Name: my-express-app</li><li>Task Role: Leave empty</li><li>Network Mode: default</li><li>Task memory (MiB): 128 (You can use whatever size that fits your application needs)</li><li>Task CPU (unit): 128 (You can use whatever size that fits your application needs)</li><li>Container: Click on Add container<ul><li>Container name: my-express-app</li><li>Image: XXXXXXXXXXX.region.amazonaws.com/my-express-app:latest</li><li>Port mappings: Host - 0, Container port: 3000</li><li>Configure the remaining to fit your application needs</li><li>You can enable Log configuration so you can view the application logs on <a href=https://console.aws.amazon.com/cloudwatch/home>CloudWatch</a>.</li></ul></li></ul><p>Once you&rsquo;re done, click on Create. Next, we&rsquo;ll create a Service.
A service lets you specify how many copies of your task definition to run and maintain in a cluster.</p><p>Click the <code>Actions</code> dropdown and select Create Service</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/create-service-from-task-def.png alt="Creating an ecs service"></p><p>You can use the following configuration to create the service:</p><ul><li>Launch type: EC2</li><li>Task Definition: my-express-app</li><li>Cluster: my-express-app (or whatever cluster you created)</li><li>Service name: MyExpressAppService</li><li>Service type: Replica</li><li>Number of tasks: 1 (Or whatever number fits your application needs).</li><li>Minimum healthy percent: 100</li><li>Maximum percent: 200</li><li>Deployment type: Rolling update</li><li>Placement Templates: AZ Balanced Spread</li><li>Load balancing: Application Load Balancer<ul><li>Load balancer name: Select the load balancer we created earlier</li><li>Container to load balance: Click on Add to load balancer</li><li>Select the target group we created earlier or create a new one here</li></ul></li><li>Use default in the remaining steps or configure to your application needs</li></ul><p>Once the service is created, it&rsquo;ll run the task in the cluster.</p><h2 id=setup-cd-with-bitbucket>Setup CD with Bitbucket</h2><p>We are going to create a new repository on Bitbucket. You can name it anything. I named mine <code>my-express-app</code>.</p><p><img src=/images/easy-deployment-with-bitbucket-and-ecs/create-repository-bitbucket.png alt="Creating bitbucket repository"></p><p>Automated CI/CD comes built-in with Bitbucket. To enable it, navigate to Repository Settings > Pipelines > Settings and switch it on.</p><h2 id=bitbucket-pipeline-file>Bitbucket pipeline file</h2><p>Bitbucket uses a file named: bitbucket-pipelines.yml for automating CI/CD. Create the file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>definitions</span>:
  <span style=color:#f92672>services</span>:
    <span style=color:#f92672>push-image</span>: <span style=color:#75715e>&amp;push-image</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build and Push Docker Image</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>atlassian/pipelines-awscli</span>
      <span style=color:#f92672>caches</span>:
        - <span style=color:#ae81ff>docker</span>
      <span style=color:#f92672>services</span>:
        - <span style=color:#ae81ff>docker</span>
      <span style=color:#f92672>script</span>:
        - <span style=color:#ae81ff>export BUILD_ID=$BITBUCKET_BRANCH_$BITBUCKET_COMMIT_$BITBUCKET_BUILD_NUMBER</span>
        - <span style=color:#ae81ff>export DOCKER_URI=$DOCKER_IMAGE_URL:latest</span>
        <span style=color:#75715e># Login to docker registry on AWS</span>
        - <span style=color:#ae81ff>eval $(aws ecr get-login --no-include-email)</span>
        <span style=color:#75715e># Build image</span>
        - <span style=color:#ae81ff>docker build -t $DOCKER_URI .</span>
        <span style=color:#75715e># Push image to private registry</span>
        - <span style=color:#ae81ff>docker push $DOCKER_URI</span>

    <span style=color:#f92672>deploy-to-ecs</span>: <span style=color:#75715e>&amp;deploy-to-ecs</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Deploy to ECS</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>atlassian/pipelines-awscli</span>
      <span style=color:#f92672>script</span>:
        - <span style=color:#f92672>pipe</span>: <span style=color:#ae81ff>atlassian/aws-ecs-deploy:1.1.0</span>
          <span style=color:#f92672>variables</span>:
            <span style=color:#f92672>AWS_ACCESS_KEY_ID</span>: <span style=color:#ae81ff>$AWS_ACCESS_KEY_ID</span>
            <span style=color:#f92672>AWS_SECRET_ACCESS_KEY</span>: <span style=color:#ae81ff>$AWS_SECRET_ACCESS_KEY</span>
            <span style=color:#f92672>AWS_DEFAULT_REGION</span>: <span style=color:#ae81ff>$AWS_DEFAULT_REGION</span>
            <span style=color:#f92672>CLUSTER_NAME</span>: <span style=color:#e6db74>&#39;my-express-app&#39;</span>
            <span style=color:#f92672>SERVICE_NAME</span>: <span style=color:#e6db74>&#39;MyExpressAppService&#39;</span>
            <span style=color:#f92672>TASK_DEFINITION</span>: <span style=color:#e6db74>&#34;task-definition.json&#34;</span>

<span style=color:#f92672>pipelines</span>:
  <span style=color:#f92672>branches</span>:
    <span style=color:#f92672>master</span>:
      - <span style=color:#f92672>step</span>: <span style=color:#75715e>*push-image</span>
      - <span style=color:#f92672>step</span>: <span style=color:#75715e>*deploy-to-ecs</span>

</code></pre></div><p>You&rsquo;d notice <code>TASK_DEFINITION</code>. This is needed to update the ECS service for deployment. So let&rsquo;s create one:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>touch task-definition.json
</code></pre></div><p>Paste this in the task definition file</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;containerDefinitions&#34;</span>: [
    {
      <span style=color:#f92672>&#34;logConfiguration&#34;</span>: {
        <span style=color:#f92672>&#34;logDriver&#34;</span>: <span style=color:#e6db74>&#34;awslogs&#34;</span>,
        <span style=color:#f92672>&#34;options&#34;</span>: {
          <span style=color:#f92672>&#34;awslogs-group&#34;</span>: <span style=color:#e6db74>&#34;/ecs/my-express-app&#34;</span>,
          <span style=color:#f92672>&#34;awslogs-region&#34;</span>: <span style=color:#e6db74>&#34;us-east-1&#34;</span>,
          <span style=color:#f92672>&#34;awslogs-stream-prefix&#34;</span>: <span style=color:#e6db74>&#34;ecs&#34;</span>
        }
      },
      <span style=color:#f92672>&#34;portMappings&#34;</span>: [
        {
          <span style=color:#f92672>&#34;hostPort&#34;</span>: <span style=color:#ae81ff>0</span>,
          <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;tcp&#34;</span>,
          <span style=color:#f92672>&#34;containerPort&#34;</span>: <span style=color:#ae81ff>3000</span>
        }
      ],
      <span style=color:#f92672>&#34;cpu&#34;</span>: <span style=color:#ae81ff>0</span>,
      <span style=color:#f92672>&#34;image&#34;</span>: <span style=color:#e6db74>&#34;XXXXXXXXXXX.region.amazonaws.com/my-express-app:latest&#34;</span>,
      <span style=color:#f92672>&#34;essential&#34;</span>: <span style=color:#66d9ef>true</span>,
      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;my-express-app&#34;</span>
    }
  ],
  <span style=color:#f92672>&#34;memory&#34;</span>: <span style=color:#e6db74>&#34;128&#34;</span>,
  <span style=color:#f92672>&#34;family&#34;</span>: <span style=color:#e6db74>&#34;my-express-app&#34;</span>,
  <span style=color:#f92672>&#34;requiresCompatibilities&#34;</span>: [<span style=color:#e6db74>&#34;EC2&#34;</span>],
  <span style=color:#f92672>&#34;cpu&#34;</span>: <span style=color:#e6db74>&#34;128&#34;</span>
}
</code></pre></div><p>Now we need to put the following environment variables on our bitbucket repository:</p><ul><li>DOCKER_IMAGE_URL</li><li>AWS_DEFAULT_REGION</li><li>AWS_ACCESS_KEY_ID</li><li>AWS_SECRET_ACCESS_KEY</li></ul><p>Navigate to Repository Settings > Repository variables >
<img src=/images/easy-deployment-with-bitbucket-and-ecs/bitbucket-repository-variables.png alt="Bitbucket repository variables"></p><p>Once you add them, commit and push to bitbucket to trigger the pipeline and the deployment process is run.</p><p>The following things occur:</p><ul><li>The docker image is built and pushed to the AWS ECR repository you created</li><li>The task definition is updated with the <code>task-definition.json</code> file</li><li>The service (MyExpressAppService) is updated</li><li>The service automatically registers a new instance of the task and begins draining the old task running</li><li>The new task is dynamically registered on the Application Load Balancer</li></ul><p>You can check the full bitbucket repository <a href=https://bitbucket.org/olaoluwa-98/my-express-app>here</a></p></article></div><aside id=meta><div><section><span class=entry-meta><time itemprop=datePublished datetime=2020-07-13>July 13, 2020 | 1163 Words</time></span></section><ul id=tags><li><a href=https://codechauffeur.com/tags/ci/cd>CI/CD</a></li><li><a href=https://codechauffeur.com/tags/deployment>Deployment</a></li><li><a href=https://codechauffeur.com/tags/devops>DevOps</a></li><li><a href=https://codechauffeur.com/tags/aws>AWS</a></li><li><a href=https://codechauffeur.com/tags/bitbucket>Bitbucket</a></li><li><a href=https://codechauffeur.com/tags/docker>Docker</a></li></ul></div><div><a class=previous href=https://codechauffeur.com/using-a-database-url-parser-in-nodejs/>Using a Database URL Parser in NodeJs</a> |
<a class=next href=https://codechauffeur.com/a-simple-road-map-to-learn-new-frameworks/>A Simple Road Map to Learn New Frameworks</a></div></aside></main></div><footer role=contentinfo><div class=hr></div><div class=footer-links><a href=http://twitter.com/olaoluwa_98>Twitter</a> /
<a href=https://github.com/olaoluwa-98>GitHub</a> /
<a href=mailto:awotunde.emmanuel1@gmail.com target=_blank>Email</a> /
<a href=/articles/index.xml>RSS</a> /</div><div class=copyright>© Emmanuel Awotunde</div></footer><script src=https://unpkg.com/medium-zoom@1.0.4/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('img'));</script></div></body></html>